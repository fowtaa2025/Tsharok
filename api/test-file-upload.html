<!DOCTYPE html>
<!--
    File Upload Handler Testing Tool
    
    PURPOSE: Interactive testing interface for file-upload-handler.php
    
    HOW TO USE:
    1. Open this file in a web browser
    2. Select a file to upload
    3. Configure upload options (type, image processing, etc.)
    4. Click "Upload File" to test the endpoint
    5. View the response and uploaded file information
    
    REQUIREMENTS:
    - PHP server must be running
    - User must be logged in
    - Intervention/Image library should be installed (composer install)
    
    ENDPOINT TESTED: file-upload-handler.php
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test File Upload Handler - Tsharok</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#7C3AED',
                    }
                }
            }
        }
    </script>
    <style>
        .drop-zone {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #4F46E5;
            background-color: #eef2ff;
        }
        .file-preview {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-xl shadow-md p-8 mb-6">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-upload text-primary mr-2"></i>
                    Test File Upload Handler
                </h1>
                <p class="text-gray-600 mb-4">Test the robust file upload handler with staging and image processing</p>
                
                <div class="flex items-center gap-2 text-sm">
                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full">
                        <i class="fas fa-check mr-1"></i>Staging Support
                    </span>
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full">
                        <i class="fas fa-image mr-1"></i>Image Processing
                    </span>
                    <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full">
                        <i class="fas fa-shield-alt mr-1"></i>Security Validation
                    </span>
                </div>
            </div>

            <!-- Upload Form -->
            <div class="bg-white rounded-xl shadow-md p-8 mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-6">Upload File</h2>

                <!-- Drag and Drop Zone -->
                <div id="dropZone" class="drop-zone rounded-lg p-12 text-center mb-6 cursor-pointer">
                    <input type="file" id="fileInput" class="hidden" accept="image/*,application/pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,video/*">
                    <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                    <p class="text-lg font-medium text-gray-700 mb-2">Drag & Drop your file here</p>
                    <p class="text-sm text-gray-500 mb-4">or click to browse</p>
                    <p class="text-xs text-gray-400">Supported: Images, Documents, Videos (max 100MB)</p>
                </div>

                <!-- File Preview -->
                <div id="filePreview" class="hidden mb-6">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-start gap-4">
                            <div id="previewContainer" class="flex-1">
                                <!-- Preview will be inserted here -->
                            </div>
                            <button onclick="clearFile()" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Upload Options -->
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Type</label>
                        <select id="uploadType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="content">Content (Course Materials)</option>
                            <option value="profile">Profile Picture</option>
                            <option value="thumbnail">Thumbnail</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Course ID (for content uploads)</label>
                        <input type="number" id="courseId" value="1" placeholder="Enter course ID" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>

                    <div class="border-t pt-4">
                        <label class="flex items-center cursor-pointer mb-4">
                            <input type="checkbox" id="processImage" checked class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary">
                            <span class="ml-2 text-sm font-medium text-gray-700">Process Images (resize & optimize)</span>
                        </label>

                        <div id="imageOptions" class="ml-7 space-y-3">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Max Width (px)</label>
                                    <input type="number" id="maxWidth" value="1920" 
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Max Height (px)</label>
                                    <input type="number" id="maxHeight" value="1080" 
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Quality (1-100): <span id="qualityValue">85</span></label>
                                <input type="range" id="quality" min="1" max="100" value="85" 
                                       class="w-full" oninput="document.getElementById('qualityValue').textContent = this.value">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Button -->
                <button id="uploadBtn" onclick="uploadFile()" disabled
                        class="w-full bg-gray-300 text-gray-500 px-6 py-3 rounded-lg font-medium cursor-not-allowed">
                    <i class="fas fa-upload mr-2"></i>Select a file first
                </button>

                <!-- Progress Bar -->
                <div id="progressContainer" class="hidden mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">Uploading...</span>
                        <span id="progressText" class="text-sm text-gray-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Results Display -->
            <div class="bg-white rounded-xl shadow-md p-8" id="resultsContainer" style="display: none;">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-code text-primary mr-2"></i>Upload Response
                    </h2>
                    <button onclick="copyResponse()" class="text-primary hover:text-indigo-700 font-medium text-sm">
                        <i class="fas fa-copy mr-1"></i>Copy
                    </button>
                </div>
                
                <pre id="results" class="bg-gray-900 text-green-400 rounded-lg p-4 overflow-x-auto text-sm mb-6"></pre>
                
                <!-- Uploaded Files Display -->
                <div id="uploadedFilesContainer" class="hidden">
                    <h3 class="font-bold text-gray-900 mb-4">Uploaded Files</h3>
                    <div id="uploadedFiles" class="grid md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let lastResponse = null;

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const processImageCheckbox = document.getElementById('processImage');

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFileSelect(e.target.files[0]);
            }
        });

        // Toggle image options based on checkbox
        processImageCheckbox.addEventListener('change', (e) => {
            const imageOptions = document.getElementById('imageOptions');
            imageOptions.style.display = e.target.checked ? 'block' : 'none';
        });

        function handleFileSelect(file) {
            selectedFile = file;
            
            // Show file preview
            const previewContainer = document.getElementById('previewContainer');
            const filePreview = document.getElementById('filePreview');
            
            const fileSize = formatBytes(file.size);
            const fileType = file.type || 'unknown';
            
            let previewHTML = `
                <div class="flex items-center gap-4">
                    <div class="bg-primary text-white w-12 h-12 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-file text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium text-gray-900">${file.name}</p>
                        <p class="text-sm text-gray-500">${fileSize} â€¢ ${fileType}</p>
                    </div>
                </div>
            `;
            
            // Show image preview if it's an image
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewHTML = `
                        <img src="${e.target.result}" alt="Preview" class="file-preview rounded-lg mb-2">
                        <p class="text-sm text-gray-600">${file.name} - ${fileSize}</p>
                    `;
                    previewContainer.innerHTML = previewHTML;
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.innerHTML = previewHTML;
            }
            
            filePreview.classList.remove('hidden');
            
            // Enable upload button
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = false;
            uploadBtn.className = 'w-full bg-primary text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition font-medium';
            uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload File';
        }

        function clearFile() {
            selectedFile = null;
            fileInput.value = '';
            document.getElementById('filePreview').classList.add('hidden');
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.className = 'w-full bg-gray-300 text-gray-500 px-6 py-3 rounded-lg font-medium cursor-not-allowed';
            uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Select a file first';
        }

        async function uploadFile() {
            if (!selectedFile) {
                alert('Please select a file first');
                return;
            }

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('upload_type', document.getElementById('uploadType').value);
            formData.append('course_id', document.getElementById('courseId').value);
            formData.append('process_image', document.getElementById('processImage').checked ? 'true' : 'false');
            formData.append('max_width', document.getElementById('maxWidth').value);
            formData.append('max_height', document.getElementById('maxHeight').value);
            formData.append('quality', document.getElementById('quality').value);

            // Show progress
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const uploadBtn = document.getElementById('uploadBtn');
            
            progressContainer.classList.remove('hidden');
            uploadBtn.disabled = true;
            uploadBtn.className = 'w-full bg-gray-300 text-gray-500 px-6 py-3 rounded-lg font-medium cursor-not-allowed';
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';

            try {
                const xhr = new XMLHttpRequest();
                
                // Upload progress
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percent + '%';
                        progressText.textContent = percent + '%';
                    }
                });

                // Upload complete
                xhr.addEventListener('load', () => {
                    progressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                    
                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        lastResponse = data;
                        displayResults(data);
                        
                        if (data.success) {
                            showToast('File uploaded successfully!', 'success');
                            clearFile();
                        } else {
                            showToast(data.message || 'Upload failed', 'error');
                        }
                    } else {
                        showToast('Upload failed with status: ' + xhr.status, 'error');
                    }
                    
                    uploadBtn.disabled = false;
                    uploadBtn.className = 'w-full bg-primary text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition font-medium';
                    uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload File';
                });

                xhr.addEventListener('error', () => {
                    progressContainer.classList.add('hidden');
                    showToast('Upload failed: Network error', 'error');
                    uploadBtn.disabled = false;
                    uploadBtn.className = 'w-full bg-primary text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition font-medium';
                    uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload File';
                });

                xhr.open('POST', 'file-upload-handler.php', true);
                xhr.send(formData);

            } catch (error) {
                console.error('Upload error:', error);
                progressContainer.classList.add('hidden');
                showToast('An error occurred during upload', 'error');
                uploadBtn.disabled = false;
            }
        }

        function displayResults(data) {
            document.getElementById('results').textContent = JSON.stringify(data, null, 2);
            document.getElementById('resultsContainer').style.display = 'block';
            
            if (data.success && data.data && data.data.files) {
                displayUploadedFiles(data.data.files);
            }
            
            document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function displayUploadedFiles(files) {
            const container = document.getElementById('uploadedFiles');
            const filesContainer = document.getElementById('uploadedFilesContainer');
            
            container.innerHTML = '';
            
            Object.entries(files).forEach(([type, fileData]) => {
                const card = document.createElement('div');
                card.className = 'border border-gray-200 rounded-lg p-4';
                
                let preview = '';
                if (fileData.dimensions) {
                    preview = `<img src="${fileData.url}" alt="${type}" class="w-full h-32 object-cover rounded mb-2">`;
                }
                
                card.innerHTML = `
                    ${preview}
                    <h4 class="font-semibold text-gray-900 mb-1 capitalize">${type}</h4>
                    <p class="text-sm text-gray-600 mb-1">${fileData.filename}</p>
                    <p class="text-xs text-gray-500">${fileData.size_formatted}</p>
                    ${fileData.dimensions ? `<p class="text-xs text-gray-500">${fileData.dimensions.width}x${fileData.dimensions.height}</p>` : ''}
                    <a href="${fileData.url}" target="_blank" class="text-primary hover:text-indigo-700 text-sm font-medium mt-2 inline-block">
                        <i class="fas fa-external-link-alt mr-1"></i>View
                    </a>
                `;
                
                container.appendChild(card);
            });
            
            filesContainer.classList.remove('hidden');
        }

        function copyResponse() {
            if (lastResponse) {
                navigator.clipboard.writeText(JSON.stringify(lastResponse, null, 2))
                    .then(() => showToast('Response copied!', 'success'))
                    .catch(() => showToast('Failed to copy', 'error'));
            }
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed top-20 right-4 z-50 px-6 py-4 rounded-lg shadow-xl transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>

