<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File View - Tsharok</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Cairo:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/minimalist-design.css">
    <link rel="stylesheet" href="../assets/css/design-system.css">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#00897b',
                        secondary: '#263238',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', 'Cairo', sans-serif;
        }

        .preview-container {
            background: #fafafa;
        }

        .file-badge {
            background: #00897b;
        }

        * {
            border-radius: 0 !important;
        }

        .rounded-full {
            border-radius: 50% !important;
        }
    </style>
    <script src="../assets/js/i18n.js"></script>
    <script src="student_chatbot.js"></script>
</head>

<body class="min-h-screen">
    <!-- Page Background Container -->
    <div class="bg-shapes-container min-h-screen">
        <!-- Background Shapes -->
        <div class="bg-shape bg-circle"></div>
        <div class="bg-shape bg-rounded-rect"></div>

        <!-- Top Navigation -->
        <nav class="bg-white border-b border-gray-200 shadow-sm relative z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Left Side - Logo -->
                    <div class="flex items-center">
                        <a href="student.html" class="flex items-center">
                            <img src="../assets/images/Logo.png" alt="Tsharok Logo" class="h-16">
                        </a>
                    </div>

                    <!-- Right Side - User Info -->
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-700 font-medium" data-user-name>student name</span>

                        <!-- Profile Dropdown -->
                        <div class="relative">
                            <button onclick="toggleProfileMenu()" id="profileButton"
                                class="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold hover:opacity-90 transition">
                                <span id="profileInitial">S</span>
                            </button>

                            <!-- Dropdown Menu -->
                            <div id="profileMenu"
                                class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-200 py-2 z-50">
                                <!-- User Info -->
                                <div class="px-4 py-3 border-b border-gray-200">
                                    <p class="text-sm font-semibold text-gray-900" data-user-name>student name</p>
                                    <p class="text-xs text-gray-500" data-user-email>student@email.com</p>
                                </div>

                                <!-- Menu Items -->
                                <a href="profile.html"
                                    class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-100 transition">
                                    <i class="fas fa-user-circle w-5 mr-3 text-gray-600"></i>
                                    <span data-i18n="file.profile.myProfile">My Profile</span>
                                </a>

                                <a href="settings.html"
                                    class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-100 transition">
                                    <i class="fas fa-cog w-5 mr-3 text-gray-600"></i>
                                    <span data-i18n="file.profile.settings">Settings</span>
                                </a>

                                <div class="border-t border-gray-200 my-2"></div>

                                <a href="#" onclick="logout(); return false;"
                                    class="flex items-center px-4 py-3 text-red-600 hover:bg-red-50 transition">
                                    <i class="fas fa-sign-out-alt w-5 mr-3"></i>
                                    <span data-i18n="file.profile.logout">Logout</span>
                                </a>
                            </div>
                        </div>

                        <button onclick="toggleLanguage()" class="text-gray-700 hover:text-primary font-medium"
                            data-i18n="nav.arabic">
                            العربية
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- Breadcrumb -->
            <div class="flex items-center gap-2 text-sm text-gray-500 mb-6">
                <a href="student.html" class="hover:text-primary" data-i18n="file.breadcrumb.dashboard">Dashboard</a>
                <i class="fas fa-chevron-right text-xs"></i>
                <a href="#" id="courseBreadcrumb" class="hover:text-primary">Course</a>
                <i class="fas fa-chevron-right text-xs"></i>
                <span id="fileBreadcrumb" class="text-gray-700">File</span>
            </div>

            <div class="grid lg:grid-cols-3 gap-6">
                <!-- Left Side - File Content Preview (2 columns) -->
                <div class="lg:col-span-2">
                    <!-- File Preview Area -->
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                        <!-- File Header -->
                        <div class="bg-gradient-to-r from-teal-600 to-teal-500 p-4 text-white">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div id="fileTypeIcon"
                                        class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-file-alt text-2xl"></i>
                                    </div>
                                    <div>
                                        <h1 id="fileName" class="text-xl font-bold">File Name</h1>
                                        <p id="fileType" class="text-teal-100 text-sm">Document</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="downloadFile()"
                                        class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition"
                                        data-i18n-title="file.header.download">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button onclick="shareFile()"
                                        class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition"
                                        data-i18n-title="file.header.share">
                                        <i class="fas fa-share-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Preview Content -->
                        <div id="filePreview"
                            class="preview-container min-h-[750px] flex items-center justify-center p-8">
                            <!-- Placeholder -->
                            <div id="contentPlaceholder" class="text-center">
                                <div
                                    class="w-24 h-24 bg-white rounded-2xl shadow-lg flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-file-alt text-4xl text-gray-400"></i>
                                </div>
                                <p class="text-xl font-semibold text-gray-600 mb-2"
                                    data-i18n="file.preview.fileContent">File Content</p>
                                <p class="text-gray-400" data-i18n="file.preview.previewWillAppear">Preview will appear
                                    here</p>
                            </div>

                            <!-- Image Preview -->
                            <img id="imagePreview"
                                class="hidden max-w-full max-h-[700px] rounded-lg shadow-lg object-contain"
                                alt="File preview">

                            <!-- Video Preview -->
                            <video id="videoPreview" class="hidden w-full max-h-[700px] rounded-lg shadow-lg" controls>
                                <span data-i18n="file.preview.videoNotSupported">Your browser does not support the video
                                    tag.</span>
                            </video>

                            <!-- PDF Preview -->
                            <iframe id="pdfPreview" class="hidden w-full h-[700px] rounded-lg border-0"></iframe>

                            <!-- Document Preview (non-viewable) -->
                            <div id="docPreview" class="hidden text-center">
                                <div
                                    class="w-24 h-24 bg-white rounded-2xl shadow-lg flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-file-word text-4xl text-blue-500"></i>
                                </div>
                                <p class="text-xl font-semibold text-gray-600 mb-2"
                                    data-i18n="file.preview.documentFile">Document File</p>
                                <p class="text-gray-500 mb-4" data-i18n="file.preview.cannotPreview">This document
                                    cannot be previewed in browser</p>
                                <button onclick="downloadFile()"
                                    class="bg-primary text-white px-6 py-3 rounded-xl hover:bg-primary-dark transition shadow-lg">
                                    <i class="fas fa-download mr-2"></i><span
                                        data-i18n="file.preview.downloadToView">Download to View</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- File Description -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 mt-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-bold text-gray-800">
                                <i class="fas fa-info-circle text-primary mr-2"></i><span
                                    data-i18n="file.description.title">Description</span>
                            </h3>
                            <button id="editDescBtn" onclick="toggleEditDescription()"
                                class="hidden text-primary hover:text-primary-dark text-sm">
                                <i class="fas fa-edit mr-1"></i><span data-i18n="file.description.edit">Edit</span>
                            </button>
                        </div>
                        <p id="fileDescription" class="text-gray-600 leading-relaxed">
                            No description available for this file.
                        </p>
                        <!-- Edit Description Form (hidden by default) -->
                        <div id="editDescForm" class="hidden">
                            <textarea id="descriptionInput"
                                class="w-full p-3 border border-gray-200 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                rows="4" data-i18n-placeholder="file.description.placeholder"></textarea>
                            <div class="flex justify-end gap-2 mt-2">
                                <button onclick="cancelEditDescription()"
                                    class="px-4 py-2 text-gray-600 hover:text-gray-800 text-sm"
                                    data-i18n="file.description.cancel">
                                    Cancel
                                </button>
                                <button onclick="saveDescription()"
                                    class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-dark text-sm">
                                    <i class="fas fa-save mr-1"></i><span data-i18n="file.description.save">Save</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Side - Info & Comments (1 column) -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- File Info Card -->
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-file-invoice text-primary mr-2"></i><span data-i18n="file.info.title">File
                                Information</span>
                        </h3>

                        <!-- Average Rating from all users -->
                        <div class="mb-4 pb-4 border-b">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-600" data-i18n="file.info.knowledgeRating">Knowledge
                                    Rating</span>
                                <div class="flex items-center gap-2">
                                    <div class="flex items-center gap-0.5" id="avgRatingStars">
                                        <i class="far fa-star text-lg text-gray-300"></i>
                                        <i class="far fa-star text-lg text-gray-300"></i>
                                        <i class="far fa-star text-lg text-gray-300"></i>
                                        <i class="far fa-star text-lg text-gray-300"></i>
                                        <i class="far fa-star text-lg text-gray-300"></i>
                                    </div>
                                    <span id="avgRatingValue" class="text-lg font-bold text-yellow-500">0.0</span>
                                </div>
                            </div>
                            <div class="text-xs text-gray-400 text-right">
                                <span id="totalRatings">0</span> <span data-i18n="file.info.ratings">ratings</span>
                            </div>
                        </div>

                        <!-- File Details -->
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500"><i class="fas fa-user-circle mr-2"></i><span
                                        data-i18n="file.info.uploadedBy">Uploaded by</span></span>
                                <div class="flex items-center gap-2">
                                    <!-- Uploader Avatar (rectangular/square) -->
                                    <div id="uploaderAvatar"
                                        class="w-8 h-8 rounded-lg bg-primary flex items-center justify-center text-white font-bold text-sm">
                                        S
                                    </div>
                                    <span id="uploadedBy" class="text-gray-800 font-medium">Student</span>
                                </div>
                            </div>

                            <div class="flex items-center justify-between">
                                <span class="text-gray-500"><i class="fas fa-calendar mr-2"></i><span
                                        data-i18n="file.info.uploadDate">Upload Date</span></span>
                                <span id="uploadDate" class="text-gray-800">-</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500"><i class="fas fa-file mr-2"></i><span
                                        data-i18n="file.info.fileType">File Type</span></span>
                                <span id="fileExtension" class="text-gray-800 uppercase">-</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500"><i class="fas fa-weight mr-2"></i><span
                                        data-i18n="file.info.fileSize">File Size</span></span>
                                <span id="fileSize" class="text-gray-800">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Comments Section -->
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-comments text-primary mr-2"></i><span
                                data-i18n="file.comments.title">Comments</span>
                            <span id="commentCount" class="text-sm font-normal text-gray-500 ml-2">(0)</span>
                        </h3>

                        <!-- Add Comment -->
                        <div class="mb-4">
                            <div class="flex items-start gap-3">
                                <div id="commentUserAvatar"
                                    class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                                    <span id="commentUserInitial" class="text-white font-bold">S</span>
                                </div>
                                <div class="flex-1">
                                    <textarea id="commentInput" data-i18n-placeholder="file.comments.placeholder"
                                        class="w-full p-3 border border-gray-200 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-sm"
                                        rows="3"></textarea>
                                    <div class="flex items-center justify-between mt-2">
                                        <div class="flex items-center gap-2 text-sm">
                                            <span class="text-gray-500" data-i18n="file.comments.yourRating">Your
                                                rating:</span>
                                            <div id="commentRating" class="flex gap-1">
                                                <i class="far fa-star text-lg text-gray-300 cursor-pointer hover:text-yellow-400 transition"
                                                    onclick="setCommentRating(1)"></i>
                                                <i class="far fa-star text-lg text-gray-300 cursor-pointer hover:text-yellow-400 transition"
                                                    onclick="setCommentRating(2)"></i>
                                                <i class="far fa-star text-lg text-gray-300 cursor-pointer hover:text-yellow-400 transition"
                                                    onclick="setCommentRating(3)"></i>
                                                <i class="far fa-star text-lg text-gray-300 cursor-pointer hover:text-yellow-400 transition"
                                                    onclick="setCommentRating(4)"></i>
                                                <i class="far fa-star text-lg text-gray-300 cursor-pointer hover:text-yellow-400 transition"
                                                    onclick="setCommentRating(5)"></i>
                                            </div>
                                            <span id="commentRatingError" class="text-red-500 text-xs hidden"
                                                data-i18n="file.comments.ratingError">Rate 1-3
                                                stars minimum!</span>
                                        </div>
                                        <button onclick="addComment()"
                                            class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-dark text-sm transition">
                                            <i class="fas fa-paper-plane mr-1"></i><span
                                                data-i18n="file.comments.post">Post</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Comments List -->
                        <div id="commentsList" class="space-y-4 max-h-80 overflow-y-auto">
                            <!-- Comments will be loaded dynamically -->
                        </div>
                    </div>

                </div>
            </div>
        </main>

        <!-- Toast Container -->
        <div id="toastContainer" class="fixed bottom-6 right-6 z-50"></div>

        <script src="../assets/js/session.js"></script>
        <script src="../assets/js/background-styles.js"></script>
        <script>
            let currentFileId = null;
            let currentCourseId = null;
            let currentRating = 0;
            let commentRating = 0;

            // Load user data on page load
            document.addEventListener('DOMContentLoaded', function () {
                // Check if user is logged in and update display
                const user = typeof getCurrentUser === 'function' ? getCurrentUser() : JSON.parse(localStorage.getItem('user') || '{}');
                if (user) {
                    // Use the session.js function for consistent name handling
                    const fullName = typeof getUserFullName === 'function' ? getUserFullName(user) : (user.fullName || user.name || user.username || 'Student');

                    // Update name elements
                    const nameElements = document.querySelectorAll('[data-user-name]');
                    nameElements.forEach(el => {
                        el.textContent = fullName;
                    });

                    // Update email elements
                    if (user.email) {
                        const emailElements = document.querySelectorAll('[data-user-email]');
                        emailElements.forEach(el => {
                            el.textContent = user.email;
                        });
                    }

                    // Update profile initial and color using session.js functions
                    const initial = typeof getUserInitial === 'function' ? getUserInitial(fullName) : fullName.charAt(0).toUpperCase();
                    const profileInitial = document.getElementById('profileInitial');
                    const profileButton = document.getElementById('profileButton');
                    if (profileInitial) profileInitial.textContent = initial;

                    // Use varied color scheme
                    const colors = ['bg-primary', 'bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500'];
                    const userColor = colors[Math.abs(fullName.charCodeAt(0) || 0) % colors.length];
                    if (profileButton) {
                        profileButton.className = `w-10 h-10 rounded-lg ${userColor} flex items-center justify-center text-white font-bold hover:opacity-90 transition`;
                    }

                    // Update comment input avatar to match
                    const commentUserAvatar = document.getElementById('commentUserAvatar');
                    const commentUserInitial = document.getElementById('commentUserInitial');
                    if (commentUserAvatar) {
                        commentUserAvatar.className = `w-10 h-10 ${userColor} rounded-lg flex items-center justify-center flex-shrink-0`;
                    }
                    if (commentUserInitial) {
                        commentUserInitial.textContent = initial;
                    }
                }

                // Load file
                loadFile();
            });

            // Listen for language changes and reload file to regenerate dynamic content with new translations
            window.addEventListener('languageChanged', () => {
                // Reload file to regenerate all dynamic content with translations
                loadFile();
            });


            // Get parameters from URL

            function getParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    fileId: parseInt(params.get('fileId')) || 0,
                    courseId: parseInt(params.get('courseId')) || 1,
                    fileName: params.get('name') || 'File'
                };
            }

            // Format file size
            function formatFileSize(bytes) {
                if (!bytes) return '-';
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            }

            // Format date
            function formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            }

            // Get file type icon
            function getFileTypeIcon(extension, fileType) {
                // Check file type first
                if (fileType === 'video') return 'fa-file-video text-pink-500';

                const icons = {
                    'pdf': 'fa-file-pdf text-red-500',
                    'doc': 'fa-file-word text-blue-500',
                    'docx': 'fa-file-word text-blue-500',
                    'xls': 'fa-file-excel text-green-500',
                    'xlsx': 'fa-file-excel text-green-500',
                    'ppt': 'fa-file-powerpoint text-orange-500',
                    'pptx': 'fa-file-powerpoint text-orange-500',
                    'png': 'fa-file-image text-purple-500',
                    'jpg': 'fa-file-image text-purple-500',
                    'jpeg': 'fa-file-image text-purple-500',
                    'gif': 'fa-file-image text-purple-500',
                    'mp4': 'fa-file-video text-pink-500',
                    'avi': 'fa-file-video text-pink-500',
                    'mov': 'fa-file-video text-pink-500',
                    'mkv': 'fa-file-video text-pink-500',
                    'webm': 'fa-file-video text-pink-500',
                    'wmv': 'fa-file-video text-pink-500',
                    'flv': 'fa-file-video text-pink-500'
                };
                return icons[extension?.toLowerCase()] || 'fa-file-alt text-gray-500';
            }

            // Get file type name
            function getFileTypeName(extension, fileType) {
                // Check file type first (from upload)
                if (fileType === 'video') return t('file.fileTypes.video');
                if (fileType === 'document') return t('file.fileTypes.document');

                const types = {
                    'pdf': t('file.fileTypes.pdfDocument'),
                    'doc': t('file.fileTypes.wordDocument'),
                    'docx': t('file.fileTypes.wordDocument'),
                    'xls': t('file.fileTypes.excelSpreadsheet'),
                    'xlsx': t('file.fileTypes.excelSpreadsheet'),
                    'ppt': t('file.fileTypes.powerpoint'),
                    'pptx': t('file.fileTypes.powerpoint'),
                    'png': t('file.fileTypes.image'),
                    'jpg': t('file.fileTypes.image'),
                    'jpeg': t('file.fileTypes.image'),
                    'gif': t('file.fileTypes.image'),
                    'mp4': t('file.fileTypes.video'),
                    'avi': t('file.fileTypes.video'),
                    'mov': t('file.fileTypes.video'),
                    'mkv': t('file.fileTypes.video'),
                    'webm': t('file.fileTypes.video'),
                    'wmv': t('file.fileTypes.video'),
                    'flv': t('file.fileTypes.video')
                };
                return types[extension?.toLowerCase()] || t('file.fileTypes.file');
            }

            // Course data for breadcrumb
            const allCoursesData = {
                1: { code: '48021400-4', name: 'Calculus (1)' },
                2: { code: '48021700-6', name: 'English Language (1)' },
                3: { code: '48021503-3', name: 'Computer Programming Skills' },
                4: { code: '48021200-4', name: 'General Chemistry (1)' },
                5: { code: '48021300-4', name: 'General Physics (1)' },
                6: { code: '48021400-6', name: 'Calculus (2)' },
                7: { code: '48021701-6', name: 'English Language (2)' },
                8: { code: '48021101-3', name: 'Discrete Mathematics (1)' },
                9: { code: '48022316-3', name: 'Object-Oriented Programming (OOP)' },
                10: { code: '48021102-3', name: 'Discrete Mathematics (2)' },
                11: { code: '48022100-3', name: 'Logic Design' },
                12: { code: '48022210-3', name: 'Data Structure' },
                13: { code: '48022312-3', name: 'Systems Analysis and Design' },
                14: { code: '48022214-3', name: 'Database Management' },
                15: { code: '48022101-3', name: 'Computer Organization' },
                16: { code: '48022110-3', name: 'Operating Systems' },
                17: { code: '48022410-3', name: 'Algorithms Design' },
                18: { code: '48022311-3', name: 'Software Engineering' },
                19: { code: '48022217-3', name: 'Visual Programming' },
                20: { code: '48022517-3', name: 'Artificial Intelligence (AI)' },
                21: { code: '48022315-3', name: 'Internet Programming' },
                22: { code: '48022515-3', name: 'Machine Learning' },
                23: { code: '48022413-3', name: 'Computer Networks' },
                24: { code: '48022516-3', name: 'Natural Language Processing' },
                25: { code: '48021504-3', name: 'Analytical and Critical Thinking Skills' },
                26: { code: '48021505-3', name: 'Information Management Skills' },
                27: { code: '48021506-3', name: 'Introduction to Web Development' },
                28: { code: '48022218-3', name: 'Game Development' },
                29: { code: '48022514-3', name: 'Computer Graphics' },
                30: { code: '48022513-3', name: 'Image Processing' }
            };

            // Get course name by ID
            function getCourseName(courseId) {
                const course = allCoursesData[courseId];
                return course ? course.name : `Course ${courseId}`;
            }

            // Load file data
            async function loadFile() {
                const params = getParams();
                currentFileId = params.fileId;
                currentCourseId = params.courseId;

                try {
                    // Fetch file from database API
                    const response = await fetch(`/api/content?id=${currentFileId}`);
                    const result = await response.json();

                    if (!result.success || !result.file) {
                        console.error('Failed to load file');
                        document.getElementById('fileName').textContent = params.fileName;
                        document.getElementById('fileBreadcrumb').textContent = params.fileName;
                        return;
                    }

                    const file = result.file;

                    // Update breadcrumb with actual course name
                    document.getElementById('courseBreadcrumb').href = `course.html?id=${currentCourseId}`;

                    // Fetch course name from API
                    try {
                        const courseResponse = await fetch(`https://tsharok-api.fow-taa-2025.workers.dev/api/courses?id=${currentCourseId}`);
                        const courseData = await courseResponse.json();
                        const courseName = courseData.success && courseData.course ? courseData.course.title : 'Course';
                        document.getElementById('courseBreadcrumb').textContent = courseName;
                    } catch (error) {
                        console.error('Failed to fetch course name:', error);
                        document.getElementById('courseBreadcrumb').textContent = 'Course';
                    }

                    // Update file info
                    document.getElementById('fileName').textContent = file.title;
                    document.getElementById('fileBreadcrumb').textContent = file.title;
                    document.getElementById('fileDescription').textContent = file.description || t('file.description.noDescription');
                    document.title = file.title + ' - Tsharok';

                    // Update file info
                    const ext = file.file_key ? file.file_key.split('.').pop() : '';
                    document.getElementById('fileType').textContent = getFileTypeName(ext, file.type);
                    document.getElementById('fileTypeIcon').innerHTML = `<i class="fas ${getFileTypeIcon(ext, file.type)} text-2xl"></i>`;
                    document.getElementById('fileExtension').textContent = ext.toUpperCase() || '-';
                    document.getElementById('uploadDate').textContent = formatDate(file.upload_date);
                    document.getElementById('fileSize').textContent = formatFileSize(file.file_size);

                    // Update uploader name and avatar
                    const uploaderName = file.uploader_name || 'Student';
                    document.getElementById('uploadedBy').textContent = uploaderName;

                    // Update uploader avatar (rectangular)
                    const uploaderAvatar = document.getElementById('uploaderAvatar');
                    if (uploaderAvatar && typeof getUserInitial === 'function') {
                        const uploaderInitial = getUserInitial(uploaderName);
                        uploaderAvatar.textContent = uploaderInitial;
                    }

                    // Show edit button if current user is the uploader
                    const currentUser = getCurrentUser();
                    const editDescBtn = document.getElementById('editDescBtn');
                    if (currentUser && (currentUser.userId === file.uploader_id || currentUser.id === file.uploader_id)) {
                        editDescBtn.classList.remove('hidden');

                        // Use consistent color scheme
                        const colors = ['bg-primary', 'bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500'];
                        const uploaderColor = colors[Math.abs(uploaderName.charCodeAt(0) || 0) % colors.length];
                        uploaderAvatar.className = `w-8 h-8 rounded-lg ${uploaderColor} flex items-center justify-center text-white font-bold text-sm`;
                    }

                    // Display file content

                    displayFileContent({
                        r2Url: file.file_url,
                        type: file.type,
                        extension: ext,
                        name: file.title
                    });

                    loadComments();
                    loadUserName();
                    updateAverageRating();
                    checkFileOwnership();
                } catch (error) {
                    console.error('Error loading file:', error);
                    document.getElementById('fileName').textContent = params.fileName;
                    document.getElementById('fileBreadcrumb').textContent = params.fileName;
                }
            }

            // Display file content based on type
            function displayFileContent(file) {
                const placeholder = document.getElementById('contentPlaceholder');
                const imagePreview = document.getElementById('imagePreview');
                const videoPreview = document.getElementById('videoPreview');
                const pdfPreview = document.getElementById('pdfPreview');
                const docPreview = document.getElementById('docPreview');

                // Hide all previews first
                placeholder.classList.add('hidden');
                imagePreview.classList.add('hidden');
                videoPreview.classList.add('hidden');
                pdfPreview.classList.add('hidden');
                docPreview.classList.add('hidden');

                console.log('Displaying file:', file); // Debug log

                if (!file.r2Url && !file.fileData) {
                    // No file data, show message about file size
                    console.log('No file data found - file may be too large for browser storage');
                    placeholder.innerHTML = `
                    <div class="w-24 h-24 bg-white rounded-2xl shadow-lg flex items-center justify-center mx-auto mb-4">
                        <i class="fas ${file.type === 'video' ? 'fa-video' : 'fa-file-alt'} text-4xl text-gray-400"></i>
                    </div>
                    <p class="text-xl font-semibold text-gray-600 mb-2">${file.type === 'video' ? t('file.fileTypes.video') : t('file.fileTypes.file')} ${t('file.preview.fileContent')}</p>
                    <p class="text-gray-500 mb-4">${t('file.preview.fileTooLarge')}</p>
                    <p class="text-sm text-gray-400">${t('file.preview.browserLimit')}</p>
                    <p class="text-sm text-gray-400 mt-2">${t('file.preview.originalFile')} ${file.originalName || 'Unknown'}</p>
                `;
                    placeholder.classList.remove('hidden');
                    return;
                }

                // Get extension from file or from originalName
                let ext = file.extension?.toLowerCase() || '';
                if (!ext && file.originalName) {
                    ext = file.originalName.split('.').pop().toLowerCase();
                }

                console.log('File extension:', ext); // Debug log
                console.log('File type:', file.type); // Debug log

                // Check by file type first (document or video)
                if (file.type === 'video') {
                    // Video files
                    videoPreview.src = file.r2Url || file.fileData;
                    videoPreview.load(); // Force reload the video
                    videoPreview.classList.remove('hidden');
                    console.log('Showing video preview');
                }
                // Image files
                else if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(ext)) {
                    imagePreview.src = file.r2Url || file.fileData;
                    imagePreview.classList.remove('hidden');
                    console.log('Showing image preview');
                }
                // Video files by extension
                else if (['mp4', 'webm', 'mov', 'avi', 'mkv', 'wmv', 'flv'].includes(ext)) {
                    videoPreview.src = file.r2Url || file.fileData;
                    videoPreview.load();
                    videoPreview.classList.remove('hidden');
                    console.log('Showing video preview by extension');
                }
                // PDF files
                else if (ext === 'pdf') {
                    pdfPreview.src = file.r2Url || file.fileData;
                    pdfPreview.classList.remove('hidden');
                    console.log('Showing PDF preview');
                }
                // Document files (docx, doc, etc.)
                else if (['docx', 'doc', 'xlsx', 'xls', 'pptx', 'ppt'].includes(ext)) {
                    docPreview.classList.remove('hidden');
                    console.log('Showing document preview');
                }
                // Unknown type - show placeholder
                else {
                    placeholder.classList.remove('hidden');
                    console.log('Unknown file type, showing placeholder');
                }
            }

            // Update rating display
            function updateRatingDisplay() {
                const stars = document.querySelectorAll('#ratingStars i');
                stars.forEach((star, index) => {
                    if (index < currentRating) {
                        star.className = 'fas fa-star text-lg text-yellow-400 cursor-pointer hover:text-yellow-500';
                    } else {
                        star.className = 'far fa-star text-lg text-gray-300 cursor-pointer hover:text-yellow-400';
                    }
                });
            }

            // Calculate and display average rating from all comments and ratings
            async function updateAverageRating() {
                try {
                    const response = await fetch(`/api/ratings?contentId=${currentFileId}`);
                    const result = await response.json();

                    if (!result.success) {
                        console.error('Failed to load ratings');
                        return;
                    }

                    const avgRating = result.average || 0;
                    const count = result.count || 0;

                    document.getElementById('avgRatingValue').textContent = avgRating.toFixed(1);
                    document.getElementById('totalRatings').textContent = count;
                    updateAvgStars(avgRating);
                } catch (error) {
                    console.error('Error loading ratings:', error);
                }
            }

            // Update average rating stars display
            function updateAvgStars(rating) {
                const stars = document.querySelectorAll('#avgRatingStars i');
                stars.forEach((star, index) => {
                    if (index < Math.floor(rating)) {
                        star.className = 'fas fa-star text-lg text-yellow-400';
                    } else if (index < rating) {
                        star.className = 'fas fa-star-half-alt text-lg text-yellow-400';
                    } else {
                        star.className = 'far fa-star text-lg text-gray-300';
                    }
                });
            }

            // Set rating
            function setRating(rating) {
                currentRating = rating;
                updateRatingDisplay();

                const token = localStorage.getItem('token');
                if (!token) {
                    showToast('Please login to rate', 'error');
                    return;
                }

                // Post rating to database
                fetch('/api/ratings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        contentId: currentFileId,
                        score: rating
                    })
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            updateAverageRating();
                            showToast('Rating saved!', 'success');
                        } else {
                            throw new Error(result.error || 'Failed to save rating');
                        }
                    })
                    .catch(error => {
                        console.error('Error saving rating:', error);
                        showToast(error.message || 'Failed to save rating', 'error');
                    });
            }

            // Set comment rating
            function setCommentRating(rating) {
                commentRating = rating;
                const stars = document.querySelectorAll('#commentRating i');
                const errorEl = document.getElementById('commentRatingError');

                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.className = 'fas fa-star text-lg text-yellow-400 cursor-pointer hover:text-yellow-500 transition';
                    } else {
                        star.className = 'far fa-star text-lg text-gray-300 cursor-pointer hover:text-yellow-400 transition';
                    }
                });

                // Hide error when rating is selected
                if (rating > 0) {
                    errorEl.classList.add('hidden');
                }
            }

            // Load comments
            async function loadComments() {
                try {
                    const token = localStorage.getItem('token');
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }

                    const response = await fetch(`https://tsharok-api.fow-taa-2025.workers.dev/api/comments?contentId=${currentFileId}&userId=${token || '0'}`, { headers });
                    const result = await response.json();

                    if (!result.success) {
                        console.error('Failed to load comments');
                        return;
                    }

                    const comments = result.data?.comments || [];
                    const container = document.getElementById('commentsList');
                    document.getElementById('commentCount').textContent = `(${comments.length})`;

                    if (comments.length === 0) {
                        container.innerHTML = `
                        <div class="text-center py-6 text-gray-400">
                            <i class="fas fa-comment-slash text-3xl mb-2"></i>
                            <p>No comments yet. Be the first to comment!</p>
                        </div>
                    `;
                        return;
                    }

                    let html = '';
                    comments.forEach((comment, index) => {
                        html += getCommentHTML({
                            id: comment.id,
                            author: comment.userName,
                            text: comment.content,
                            date: formatDate(comment.createdAt),
                            rating: comment.score || 0,
                            likes: comment.likes || 0,
                            likedByMe: comment.likedByMe || false,
                            replies: comment.replies || []
                        }, index);
                    });
                    container.innerHTML = html;
                } catch (error) {
                    console.error('Error loading comments:', error);
                }
            }

            // Update average rating display
            async function updateAverageRating() {
                try {
                    const response = await fetch(`https://tsharok-api.fow-taa-2025.workers.dev/api/ratings?contentId=${currentFileId}`);
                    const result = await response.json();

                    if (result.success && result.data) {
                        const avgRating = result.data.averageRating || 0;
                        const totalRatings = result.data.totalRatings || 0;

                        // Update rating value
                        document.getElementById('avgRatingValue').textContent = avgRating.toFixed(1);
                        document.getElementById('totalRatings').textContent = totalRatings;

                        // Update stars
                        const starsContainer = document.getElementById('avgRatingStars');
                        const fullStars = Math.floor(avgRating);
                        const hasHalfStar = avgRating % 1 >= 0.5;

                        let starsHTML = '';
                        for (let i = 0; i < 5; i++) {
                            if (i < fullStars) {
                                starsHTML += '<i class="fas fa-star text-lg text-yellow-500"></i>';
                            } else if (i === fullStars && hasHalfStar) {
                                starsHTML += '<i class="fas fa-star-half-alt text-lg text-yellow-500"></i>';
                            } else {
                                starsHTML += '<i class="far fa-star text-lg text-gray-300"></i>';
                            }
                        }
                        starsContainer.innerHTML = starsHTML;
                    }
                } catch (error) {
                    console.error('Error updating average rating:', error);
                }
            }

            // Get comment HTML
            function getCommentHTML(comment, index) {
                const starsHTML = Array(5).fill(0).map((_, i) =>
                    `<i class="${i < (comment.rating || 0) ? 'fas' : 'far'} fa-star text-xs"></i>`
                ).join('');

                const initials = (comment.author || 'S').charAt(0).toUpperCase();
                const colors = ['bg-primary', 'bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500'];
                const randomColor = colors[Math.abs(comment.author?.charCodeAt(0) || 0) % colors.length];
                const likes = comment.likes || 0;
                const isLiked = comment.likedByMe ? 'fas text-red-500' : 'far text-gray-400';

                // Ensure replies array exists
                const replies = comment.replies || [];
                const replyCount = replies.length;

                // Generate replies HTML
                let repliesHTML = '';
                if (replyCount > 0) {
                    repliesHTML = replies.map((reply, replyIndex) => getReplyHTML(reply, index, replyIndex)).join('');
                }

                return `
                <div class="bg-gray-50 rounded-xl p-4" data-comment-index="${index}" data-comment-id="${comment.id || ''}">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 ${randomColor} rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="text-white text-sm font-bold">${initials}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="font-semibold text-gray-800 text-sm">${comment.author || 'Student'}</span>
                                <div class="flex text-yellow-400">${starsHTML}</div>
                                <span class="text-gray-400 text-xs">${comment.date || 'Just now'}</span>
                            </div>
                            <p class="text-gray-600 text-sm mt-1">${comment.text}</p>
                            <div class="flex items-center gap-3 mt-2">
                                <button onclick="toggleLike(${comment.id})" class="flex items-center gap-1 text-sm hover:scale-110 transition">
                                    <i class="${isLiked} fa-heart"></i>
                                    <span class="text-gray-500">${likes}</span>
                                </button>
                                <button onclick="toggleReplyForm(${index})" class="flex items-center gap-1 text-sm text-gray-500 hover:text-primary transition">
                                    <i class="far fa-comment"></i>
                                    <span>Reply</span>
                                </button>
                            </div>
                            
                            <!-- Reply Input Form (Hidden by default) -->
                            <div id="replyForm-${index}" class="hidden mt-3 pl-4 border-l-2 border-gray-300">
                                <div class="flex items-start gap-2">
                                    <textarea id="replyInput-${index}" placeholder="Write a reply..." class="flex-1 p-2 border border-gray-200 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-sm" rows="2"></textarea>
                                </div>
                                <div class="flex justify-end gap-2 mt-2">
                                    <button onclick="toggleReplyForm(${index})" class="px-3 py-1 text-gray-600 hover:text-gray-800 text-sm">
                                        Cancel
                                    </button>
                                    <button onclick="addReply(${index})" class="bg-primary text-white px-3 py-1 rounded-lg hover:bg-primary-dark text-sm transition">
                                        <i class="fas fa-paper-plane mr-1"></i>Reply
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Replies Section -->
                            ${replyCount > 0 ? `
                                <div class="mt-3">
                                    <button onclick="toggleReplies(${index})" class="flex items-center gap-1 text-sm text-primary hover:text-primary-dark font-medium transition">
                                        <i id="replyToggleIcon-${index}" class="fas fa-chevron-down text-xs"></i>
                                        <span id="replyToggleText-${index}">View ${replyCount} ${replyCount === 1 ? 'reply' : 'replies'}</span>
                                    </button>
                                    <div id="repliesContainer-${index}" class="hidden mt-2 pl-4 border-l-2 border-gray-300 space-y-2">
                                        ${repliesHTML}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            }

            // Get reply HTML
            function getReplyHTML(reply, commentIndex, replyIndex) {
                const initials = (reply.author || 'S').charAt(0).toUpperCase();
                const colors = ['bg-primary', 'bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500'];
                const randomColor = colors[Math.abs(reply.author?.charCodeAt(0) || 0) % colors.length];

                return `
                <div class="flex items-start gap-2 bg-white rounded-lg p-3">
                    <div class="w-6 h-6 ${randomColor} rounded-lg flex items-center justify-center flex-shrink-0">
                        <span class="text-white text-xs font-bold">${initials}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-gray-800 text-xs">${reply.author || 'Student'}</span>
                            <span class="text-gray-400 text-xs">${reply.date || 'Just now'}</span>
                        </div>
                        <p class="text-gray-600 text-sm mt-1">${reply.text}</p>
                    </div>
                </div>
            `;
            }

            // Toggle reply form visibility
            function toggleReplyForm(commentIndex) {
                const replyForm = document.getElementById(`replyForm-${commentIndex}`);
                const replyInput = document.getElementById(`replyInput-${commentIndex}`);

                if (replyForm.classList.contains('hidden')) {
                    replyForm.classList.remove('hidden');
                    replyInput.focus();
                } else {
                    replyForm.classList.add('hidden');
                    replyInput.value = '';
                }
            }

            // Add reply to a comment
            function addReply(commentIndex) {
                const replyInput = document.getElementById(`replyInput-${commentIndex}`);
                const text = replyInput.value.trim();

                if (!text) {
                    showToast('Please enter a reply', 'error');
                    return;
                }

                const userData = JSON.parse(localStorage.getItem('user') || '{}');
                const authorName = userData.fullName || userData.name || userData.username || 'Student';

                const reply = {
                    author: authorName,
                    text: text,
                    date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
                };

                let comments = JSON.parse(localStorage.getItem(`file_${currentCourseId}_${currentFileId}_comments`) || '[]');

                if (comments[commentIndex]) {
                    // Ensure replies array exists
                    if (!comments[commentIndex].replies) {
                        comments[commentIndex].replies = [];
                    }

                    // Add reply to the beginning of replies array
                    comments[commentIndex].replies.unshift(reply);

                    // Save to localStorage
                    localStorage.setItem(`file_${currentCourseId}_${currentFileId}_comments`, JSON.stringify(comments));

                    // Clear input and hide form
                    replyInput.value = '';
                    toggleReplyForm(commentIndex);

                    // Reload comments to show the new reply
                    loadComments();

                    showToast('Reply added!', 'success');
                }
            }

            // Toggle replies visibility
            function toggleReplies(commentIndex) {
                const repliesContainer = document.getElementById(`repliesContainer-${commentIndex}`);
                const toggleIcon = document.getElementById(`replyToggleIcon-${commentIndex}`);
                const toggleText = document.getElementById(`replyToggleText-${commentIndex}`);

                const comments = JSON.parse(localStorage.getItem(`file_${currentCourseId}_${currentFileId}_comments`) || '[]');
                const replyCount = comments[commentIndex]?.replies?.length || 0;

                if (repliesContainer.classList.contains('hidden')) {
                    // Show replies
                    repliesContainer.classList.remove('hidden');
                    toggleIcon.classList.remove('fa-chevron-down');
                    toggleIcon.classList.add('fa-chevron-up');
                    toggleText.textContent = 'Hide replies';
                } else {
                    // Hide replies
                    repliesContainer.classList.add('hidden');
                    toggleIcon.classList.remove('fa-chevron-up');
                    toggleIcon.classList.add('fa-chevron-down');
                    toggleText.textContent = `View ${replyCount} ${replyCount === 1 ? 'reply' : 'replies'}`;
                }
            }

            // Toggle like on comment
            async function toggleLike(commentId) {
                const token = localStorage.getItem('token') || sessionStorage.getItem('userId');
                if (!token) {
                    showToast('Please login to like comments', 'error');
                    return;
                }

                try {
                    console.log('Toggling like for comment:', commentId, 'with token:', token);
                    const response = await fetch('https://tsharok-api.fow-taa-2025.workers.dev/api/comments/like', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ commentId: parseInt(commentId) })
                    });

                    const result = await response.json();
                    console.log('Like response:', result);

                    if (result.success) {
                        showToast(result.message, 'success');
                        loadComments(); // Reload to show updated like count
                    } else {
                        console.error('Like failed:', result);
                        showToast(result.message || 'Failed to toggle like', 'error');
                    }
                } catch (error) {
                    console.error('Error toggling like:', error);
                    showToast('Failed to toggle like', 'error');
                }
            }

            // Toggle reply form visibility
            function toggleReplyForm(commentIndex) {
                console.log('toggleReplyForm called with index:', commentIndex);
                const form = document.getElementById(`replyForm-${commentIndex}`);
                if (form) {
                    form.classList.toggle('hidden');
                    console.log('Reply form toggled, now visible:', !form.classList.contains('hidden'));
                } else {
                    console.error('Reply form not found for index:', commentIndex);
                }
            }

            // Add reply to comment
            async function addReply(commentIndex) {
                console.log('addReply called with index:', commentIndex);
                const replyInput = document.getElementById(`replyInput-${commentIndex}`);
                const text = replyInput?.value.trim();

                if (!text) {
                    console.log('No reply text entered');
                    showToast('Please enter a reply', 'error');
                    return;
                }

                const token = localStorage.getItem('token') || sessionStorage.getItem('userId');
                if (!token) {
                    console.log('No token found');
                    showToast('Please login to reply', 'error');
                    return;
                }

                // Get comment ID from the data attribute
                const commentDiv = document.querySelector(`[data-comment-index="${commentIndex}"]`);
                const commentId = commentDiv?.getAttribute('data-comment-id');

                if (!commentId) {
                    console.error('Comment ID not found for index:', commentIndex);
                    showToast('Failed to find comment', 'error');
                    return;
                }

                console.log('Posting reply to comment:', commentId, 'with text:', text);

                try {
                    const response = await fetch('https://tsharok-api.fow-taa-2025.workers.dev/api/comments/reply', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            commentId: parseInt(commentId),
                            text: text
                        })
                    });

                    const result = await response.json();
                    console.log('Reply response:', result);

                    if (result.success) {
                        showToast('Reply added successfully!', 'success');
                        replyInput.value = '';
                        toggleReplyForm(commentIndex);
                        loadComments(); // Reload to show new reply
                    } else {
                        console.error('Reply failed:', result);
                        showToast(result.message || 'Failed to add reply', 'error');
                    }
                } catch (error) {
                    console.error('Error adding reply:', error);
                    showToast('Failed to add reply', 'error');
                }
            }

            // Add comment
            function addComment() {
                const input = document.getElementById('commentInput');
                const text = input.value.trim();
                const errorEl = document.getElementById('commentRatingError');

                if (!text) {
                    showToast('Please enter a comment', 'error');
                    return;
                }

                if (commentRating < 1) {
                    document.getElementById('commentRatingError').classList.remove('hidden');
                    return;
                }

                const token = localStorage.getItem('token');
                if (!token) {
                    showToast('Please login to comment', 'error');
                    return;
                }

                // Post comment to database
                fetch('/api/comments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        contentId: currentFileId,
                        text: text
                    })
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            // Also post rating
                            return fetch('/api/ratings', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    contentId: currentFileId,
                                    score: commentRating
                                })
                            });
                        } else {
                            throw new Error(result.error || 'Failed to post comment');
                        }
                    })
                    .then(response => response.json())
                    .then(result => {
                        // Clear input
                        document.getElementById('commentInput').value = '';
                        commentRating = 0;
                        setCommentRating(0);

                        // Reload comments
                        loadComments();

                        // Wait a moment for database to fully commit, then update average rating
                        setTimeout(() => {
                            updateAverageRating();
                        }, 500);

                        showToast('Comment posted successfully!', 'success');
                    })
                    .catch(error => {
                        console.error('Error posting comment:', error);
                        showToast(error.message || 'Failed to post comment', 'error');
                    });
            }

            // Download file
            function downloadFile() {
                const files = JSON.parse(localStorage.getItem(`course_${currentCourseId}_files`) || '[]');
                const file = files[currentFileId];

                const fileUrl = file?.r2Url || file?.fileData;

                if (fileUrl) {
                    // Create download link
                    const link = document.createElement('a');
                    link.href = fileUrl;
                    link.download = file.originalName || file.name;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('Download started!', 'success');
                } else {
                    showToast('No file data available for download', 'error');
                }
            }

            // Share file
            function shareFile() {
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(() => {
                    showToast('Link copied to clipboard!', 'success');
                }).catch(() => {
                    showToast('Failed to copy link', 'error');
                });
            }

            // Go back
            function goBack() {
                window.location.href = `course.html?id=${currentCourseId}`;
            }

            // Load user name
            function loadUserName() {
                const userData = JSON.parse(localStorage.getItem('user') || '{}');
                if (userData.name) {
                    document.getElementById('userName').textContent = userData.name;
                }
            }

            // Show toast notification
            function showToast(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    info: 'bg-gray-800'
                };
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    info: 'fa-info-circle'
                };

                const toast = document.createElement('div');
                toast.className = `${colors[type]} text-white px-5 py-3 rounded-xl shadow-lg flex items-center gap-3 transform transition-all duration-300 translate-y-2 opacity-0`;
                toast.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;
                container.appendChild(toast);

                // Animate in
                setTimeout(() => {
                    toast.classList.remove('translate-y-2', 'opacity-0');
                }, 10);

                // Remove after delay
                setTimeout(() => {
                    toast.classList.add('translate-y-2', 'opacity-0');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            // Check if current user is the file creator
            function checkFileOwnership() {
                const files = JSON.parse(localStorage.getItem(`course_${currentCourseId}_files`) || '[]');
                const file = files[currentFileId];
                const userData = JSON.parse(localStorage.getItem('user') || '{}');

                // Show edit button if:
                // 1. User is the creator (by name or id)
                // 2. File has no uploader info (legacy files)
                // 3. User is logged in and file was recently uploaded (same session)
                const isOwner = file && (
                    file.uploadedBy === userData.name ||
                    file.uploaderId === userData.id ||
                    !file.uploadedBy ||
                    !file.uploaderId
                );

                // Always show edit button for now (since we're in demo mode)
                // In production, you'd check proper authentication
                if (file) {
                    document.getElementById('editDescBtn').classList.remove('hidden');
                }
            }

            // Toggle edit description mode
            function toggleEditDescription() {
                const descEl = document.getElementById('fileDescription');
                const formEl = document.getElementById('editDescForm');
                const inputEl = document.getElementById('descriptionInput');

                descEl.classList.add('hidden');
                formEl.classList.remove('hidden');
                inputEl.value = descEl.textContent.trim() === 'No description available for this file.' ? '' : descEl.textContent.trim();
                inputEl.focus();
            }

            // Cancel edit description
            function cancelEditDescription() {
                document.getElementById('fileDescription').classList.remove('hidden');
                document.getElementById('editDescForm').classList.add('hidden');
            }

            // Save description
            async function saveDescription() {
                const inputEl = document.getElementById('descriptionInput');
                const descEl = document.getElementById('fileDescription');
                const newDesc = inputEl.value.trim();

                try {
                    const user = getCurrentUser();
                    const token = sessionStorage.getItem('token');

                    const response = await fetch('https://tsharok-api.fow-taa-2025.workers.dev/api/update-description', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            contentId: currentFileId,
                            description: newDesc
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Update display
                        descEl.textContent = newDesc || 'No description available for this file.';
                        cancelEditDescription();
                        showToast('Description saved!', 'success');
                    } else {
                        showToast(result.message || 'Failed to save description', 'error');
                    }
                } catch (error) {
                    console.error('Save description error:', error);
                    showToast('Failed to save description', 'error');
                }
            }

            // Language toggle
            function toggleLanguage() {
                const currentLang = document.documentElement.lang;
                if (currentLang === 'en') {
                    document.documentElement.lang = 'ar';
                    document.documentElement.dir = 'rtl';
                } else {
                    document.documentElement.lang = 'en';
                    document.documentElement.dir = 'ltr';
                }
            }

            // ========== PROFILE MENU FUNCTIONALITY ==========

            function toggleProfileMenu() {
                const menu = document.getElementById('profileMenu');
                menu.classList.toggle('hidden');
            }

            // Close profile menu when clicking outside
            document.addEventListener('click', function (event) {
                const menu = document.getElementById('profileMenu');
                const button = document.getElementById('profileButton');

                if (menu && button && !menu.contains(event.target) && !button.contains(event.target)) {
                    menu.classList.add('hidden');
                }
            });

            // Set comment rating
            function setCommentRating(rating) {
                commentRating = rating;
                const stars = document.querySelectorAll('#commentRating i');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.className = 'fas fa-star text-lg text-yellow-400 cursor-pointer';
                    } else {
                        star.className = 'far fa-star text-lg text-gray-300 cursor-pointer hover:text-yellow-400 transition';
                    }
                });
                document.getElementById('commentRatingError').classList.add('hidden');
            }

            // Initialize
            document.addEventListener('DOMContentLoaded', loadFile);
        </script>
    </div><!-- End of bg-shapes-container -->
    <!-- Mobile Floating Chatbot Button -->
    <div id="mobileChatbotButton" class="fixed bottom-6 right-6 z-50">
        <button onclick="toggleMobileChatbot()"
            class="w-16 h-16 bg-gradient-to-br from-teal-600 to-teal-500 rounded-full shadow-lg flex items-center justify-center text-white hover:scale-110 transition-transform">
            <i class="fas fa-robot text-2xl"></i>
        </button>
    </div>

    <!-- Mobile Chatbot Window (expandable) -->
    <div id="mobileChatbotWindow" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50"
        onclick="closeMobileChatbot()">
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl max-h-[80vh] flex flex-col"
            onclick="event.stopPropagation()">
            <!-- Header -->
            <div
                class="bg-gradient-to-br from-teal-600 to-teal-500 p-4 rounded-t-3xl flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-xl text-primary"></i>
                    </div>
                    <div class="text-white">
                        <div class="font-bold">Tsharok Assistant</div>
                        <div class="text-xs opacity-90">Always here to help</div>
                    </div>
                </div>
                <button onclick="closeMobileChatbot()" class="text-white hover:bg-white/20 rounded-full p-2 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Messages Area -->
            <div class="flex-1 overflow-y-auto p-4 bg-gray-50" id="mobileChatbotMessages">
                <div class="flex gap-2 mb-3">
                    <div
                        class="w-8 h-8 bg-gradient-to-br from-teal-600 to-teal-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <div class="bg-white p-3 rounded-xl rounded-tl-sm shadow-sm">
                            <p class="text-gray-800 text-sm">
                                👋 Hello! I'm your Tsharok Assistant. How can I help you today?
                            </p>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <button onclick="sendQuickReplyMobile('How do I add a course?')"
                                class="px-3 py-2 bg-white border-2 border-primary text-primary rounded-full text-xs font-medium hover:bg-primary hover:text-white transition">
                                Add Course
                            </button>
                            <button onclick="sendQuickReplyMobile('Show my schedule')"
                                class="px-3 py-2 bg-white border-2 border-primary text-primary rounded-full text-xs font-medium hover:bg-primary hover:text-white transition">
                                My Schedule
                            </button>
                            <button onclick="sendQuickReplyMobile('Help with assignments')"
                                class="px-3 py-2 bg-white border-2 border-primary text-primary rounded-full text-xs font-medium hover:bg-primary hover:text-white transition">
                                Assignments
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Box -->
            <div class="p-4 bg-white border-t border-gray-200">
                <div class="flex gap-2 items-center">
                    <input type="text"
                        class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-full text-sm outline-none focus:border-primary transition"
                        id="mobileChatbotInput" placeholder="Type your message..."
                        onkeypress="handleChatKeyPressMobile(event)">
                    <button onclick="sendMessageMobile()"
                        class="w-12 h-12 bg-gradient-to-br from-teal-600 to-teal-500 rounded-full text-white flex items-center justify-center hover:scale-110 transition shadow-lg">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>